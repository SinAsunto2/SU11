{% extends "base.html" %}

{% block navigation_left %}{% endblock navigation_left %}

{% block content %}

<div class="row mx-auto">       
    <div class="col-lg-12 position-relative">
        <div class="chat-wrapper pt-0 w-100 position-relative scroll-bar bg-white theme-dark-bg">
            <div class="chat-body p-3 ">
                <div class="messages-content pb-5">

                    <div class="message-item">
                        <div class="message-user">
                            <figure class="avatar">
                                <img src="{{avatar_bot}}" alt="image">
                            </figure>
                            <div>
                                <h5>Libur</h5>
                            </div>
                        </div>
                        {% if has_previos_interaction is False %}
                        <div class="message-wrap">
                            <p>Â¡Saludos! QuÃ© gusto verte por aquÃ­. ğŸŒŸ</p>
                            <p>Soy Libur, tu compaÃ±ero virtual. Estoy aquÃ­ para guiarte a travÃ©s de emocionantes desafÃ­os y misterios. ğŸ¤–âœ¨</p>
                            <p>AquÃ­ tienes un adelanto de lo que te espera:</p>
                            âœ Experimenta <strong>{{user_state.all_challenges}}</strong> retos intrigantes que pondrÃ¡n a prueba tu astucia. ğŸ§ ğŸ”<br>
                            âœ Descubre <strong>{{user_state.all_secrets}}</strong> secretos ocultos que te llevarÃ¡n a rincones inexplorados. ğŸ—ï¸ğŸŒ„<br><br>
                            <p>Para comenzar, escribe la palabra clave: <strong>RETO1</strong></p>
                            <p>Una vez que escribas la palabra clave, recibirÃ¡s tu primer reto. Â¡Buena suerte! ğŸ€ğŸ‰</p>
                        </div>
                        {% else %}
                        <div class="message-wrap">
                            <p>Â¡Hola de nuevo! ğŸŒŸ</p>
                            <p>Has progresado en SU11 completando <strong>{{user_state.all_completed_challenges}}</strong> de los <strong>{{user_state.all_challenges}}</strong> retos disponibles. ğŸš€<br>
                            AdemÃ¡s, has descubierto  <strong>{{user_state.all_completed_secrets}}</strong> de los <strong>{{user_state.all_secrets}}</strong> secretos. ğŸ”‘<br>
                            Con un total de <strong>{{user.score}}</strong> puntos, te encuentras en la posiciÃ³n <strong>{{user_ranking_position}}</strong> en el ranking. ğŸ†<br>
                            Â¡Sigue asÃ­! ğŸ¦¾</p>

                            {% if user_state.next_challenge %}
                                <p>Â¡Ey, veo que tienes un reto pendiente! ğŸ˜Š Ingresa la palabra clave <strong>{{user_state.next_challenge.keyword}}</strong> y dÃ©mosle inicio. ğŸš€âœ¨</p>
                            {% else %}
                                <p>Â¡Impresionante! Has superado todos los retos disponibles. ğŸŒŸ Por ahora, relÃ¡jate y estate atento, pronto llegarÃ¡n mÃ¡s desafÃ­os emocionantes. âœ¨ Â¡Estamos trabajando en nuevos retos para ti! ğŸ‰ğŸ”¥</p>
                            {% endif %}

                        </div>
                        {% endif %}
                    </div>

                    {% comment %} <div class="message-item outgoing-message">
                        <div class="message-user">
                            <figure class="avatar">
                                <img src="{{user.profile_picture.url}}" alt="image">
                            </figure>
                            <div>
                                <h5>{{ user.username|title }}</h5>
                            </div>
                        </div>
                        <div class="message-wrap">...</div>
                    </div> {% endcomment %}

                    <div class="clearfix"></div>

                </div>
            </div>
        </div>

        <form class="chat-form" id='challengeForm' method='post'>
            {% csrf_token %}
            <div class="chat-bottom dark-bg p-3 shadow-none d-flex justify-content-center align-items-center">
                <div class="form-group">
                    <input type="text" name="user_response" id="userResponse" placeholder="Write your message..." required>
                </div>
                <button type="submit" id="submitBtn" class="bg-current"><i class="ti-arrow-right text-white"></i></button>
            </div>
        </form>

    </div>
</div>

<script>
    document.getElementById('challengeForm').addEventListener('submit', function(event) {
        // Prevenir el comportamiento por defecto del formulario (recargar la pÃ¡gina)
        event.preventDefault();

        // Obtener la respuesta del usuario
        var userResponse = document.getElementById('userResponse').value;

        // Enviar la respuesta del usuario
        sendUserResponse(userResponse);
    });
    
    function sendUserResponse(userResponse) {
        const csrfToken = Cookies.get('csrftoken');
    
        $.ajax({
            type: 'POST',
            url: '/users_response/',
            data: {'user_response': userResponse},
            headers: {
                "X-CSRFToken": csrfToken
            },
            success: function(response) {
                console.log(response);

                var userMessageHtml = `
                    <div class="message-item outgoing-message">
                        <div class="message-user">
                            <figure class="avatar">
                                <img src="{{user.profile_picture.url}}" alt="image">
                            </figure>
                            <div>
                                <h5>{{ user.username|title }}</h5>
                            </div>
                        </div>
                        <div class="message-wrap">${userResponse}</div>
                    </div>
                `;

                var chatContent = document.querySelector('.messages-content');
                chatContent.innerHTML += userMessageHtml;

                var botMessageHtml = `
                    <div class="message-item">
                        <div class="message-user">
                            <figure class="avatar">
                                <img src="{{avatar_bot}}" alt="image">
                            </figure>
                            <div>
                                <h5>Libur</h5>
                            </div>
                        </div>
                        <div class="message-wrap">${response.message}</div>
                        ${response.challenge_image
                            ? `<figure><img src="${response.challenge_image}" class="img-fluid rounded-3 mt-2" alt="Challenge Image"></figure>`
                            : ''
                        }
                    </div>
                `;

                chatContent.innerHTML += botMessageHtml;
                document.getElementById('userResponse').value = '';
                chatContent.scrollIntoView({block: "end"});
            },
            error: function(error) {
                console.error(error);
            }
        });
    }
</script>


{% endblock content %}